<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Hybrinear Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .trigger-red { background: #ef4444; box-shadow: 0 0 20px #ef4444; }
        .maintain-green { background: #10b981; box-shadow: 0 0 20px #10b981; }
        .m-input { width: 100%; background: #000; color: #fff; padding: 5px; border: 1px solid #334; font-size: 11px; font-family: monospace; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 p-4 font-sans">
    <div class="max-w-md mx-auto space-y-4">
        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
            <label class="text-[8px] text-slate-500 uppercase font-bold">Patient / Bed ID</label>
            <input type="text" id="patientID" class="m-input text-emerald-400" placeholder="BED-001">
        </div>

        <div id="status-light" class="w-24 h-24 mx-auto rounded-full border-4 border-slate-950 flex flex-col justify-center items-center bg-slate-800 transition-all duration-500">
            <span id="v-lab" class="text-[8px] font-bold">IDLE</span>
            <span id="o-val" class="text-xs font-mono">0.0000</span>
        </div>

        <div class="grid grid-cols-2 gap-2 bg-slate-800 p-4 rounded-xl">
            <input type="number" id="v0" placeholder="Sys" class="m-input"> <input type="number" id="v1" placeholder="Dia" class="m-input">
            <input type="number" id="v2" placeholder="Pulse" class="m-input"> <input type="number" id="v3" placeholder="SpO2" class="m-input">
            <input type="number" id="v4" placeholder="Resp" class="m-input"> <input type="number" id="v5" placeholder="Temp" class="m-input">
            <input type="number" id="v6" placeholder="Glu" class="m-input"> <input type="number" id="v7" placeholder="Urine" class="m-input">
            <input type="number" id="v8" placeholder="Lac" class="m-input"> <input type="number" id="v9" placeholder="WBC" class="m-input">
            <button onclick="process()" class="col-span-2 py-3 bg-indigo-600 rounded font-black text-xs uppercase mt-2">Process Trial</button>
        </div>

        <div class="bg-black/30 rounded p-2 text-[9px]">
            <div class="flex justify-between mb-2">
                <button onclick="pdf()">PDF Report</button> <button onclick="clearLogs()">Clear</button>
            </div>
            <table class="w-full text-left border-collapse"><tbody id="log"></tbody></table>
        </div>
    </div>

    <script>
        let sessionData = []; let trialCount = 0;
        async function process() {
            const vitals = Array.from({length:10}, (_,i) => parseFloat(document.getElementById(`v${i}`).value || [120,80,72,98,16,36.6,90,50,1.2,7.5][i]));
            const resp = await fetch('/api', { method:'POST', body: JSON.stringify({vitals, gadgetTime: new Date().toLocaleTimeString('en-GB')}) });
            const data = await resp.json();
            trialCount++; sessionData.push({...data, raw: vitals});
            
            document.getElementById('status-light').className = `w-24 h-24 mx-auto rounded-full border-4 border-slate-950 flex flex-col justify-center items-center ${data.score <= 0.368 ? 'trigger-red' : 'maintain-green'}`;
            document.getElementById('v-lab').innerText = data.verdict;
            document.getElementById('o-val').innerText = data.score.toFixed(4);

            let marker = trialCount % 10 === 0 ? ` <span class="text-orange-400">[AUDIT: ${data.score.toFixed(4)}]</span>` : "";
            if (data.score <= 0.368) marker += ` <span class="text-red-500 font-bold">[TIPPING POINT]</span>`;

            const row = `<tr class="border-b border-slate-800"><td>${data.timestamp}</td><td>${data.score.toFixed(4)}</td><td>${data.verdict}${marker}</td></tr>`;
            document.getElementById('log').insertAdjacentHTML('afterbegin', row);
        }
        function pdf() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const pID = document.getElementById('patientID').value || "Patient";
            doc.text(`Patient ID: ${pID} | Hybrinear Audit`, 15, 20);
            sessionData.forEach((d, i) => {
                doc.setTextColor(d.score <= 0.368 ? 200 : 0, 0, 0);
                doc.text(`${d.timestamp} | ${d.score.toFixed(4)} | ${d.verdict}`, 15, 40+(i*15));
            });
            doc.save(`Report_${pID}.pdf`);
        }
        function clearLogs() { location.reload(); }
    </script>
</body>
</html>
