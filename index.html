<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICU Coherence Kernel | Secure Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .maintain-green { background-color: #10b981; box-shadow: 0 0 20px #10b981; }
        .trigger-red { background-color: #ef4444; box-shadow: 0 0 20px #ef4444; }
        .m-input { width: 100%; background: #000; color: #fff; padding: 6px; border-radius: 4px; border: 1px solid #334155; font-size: 11px; font-family: monospace; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 p-4 flex flex-col items-center">
    <div class="max-w-md w-full space-y-4">
        <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 shadow-2xl">
            <label class="text-[8px] text-slate-500 uppercase font-bold">Patient / Bed ID</label>
            <input type="text" id="patientID" placeholder="Enter ID..." class="m-input text-emerald-400">
        </div>

        <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 text-center shadow-2xl">
            <div id="status-light" class="w-24 h-24 mx-auto rounded-full border-4 border-slate-900 flex flex-col justify-center items-center bg-slate-950 transition-all duration-700">
                <span id="verdict-label" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">IDLE</span>
                <span id="omega-value" class="text-sm font-mono font-black text-white/50">0.0000</span>
            </div>
            <p class="mt-3 text-[9px] font-black text-indigo-400 uppercase tracking-widest">Hybrinear Clinical Vault</p>
        </div>

        <div class="bg-slate-800/80 p-6 rounded-2xl border border-slate-700 shadow-2xl">
            <h3 class="text-emerald-400 font-bold text-center mb-4 uppercase text-xs">Clinical Hybrinear Matrix</h3>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <div><label class="text-[8px] text-slate-500 uppercase">Systolic BP</label><input type="number" id="v0" value="120" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">Diastolic BP</label><input type="number" id="v1" value="80" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">Pulse Rate</label><input type="number" id="v2" value="72" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">SpO2 %</label><input type="number" id="v3" value="98" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">Resp Rate</label><input type="number" id="v4" value="16" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">Temp Â°C</label><input type="number" id="v5" value="36.6" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">Glucose</label><input type="number" id="v6" value="90" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">Urine Output</label><input type="number" id="v7" value="50" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">Lactate</label><input type="number" id="v8" value="1.2" class="m-input"></div>
                <div><label class="text-[8px] text-slate-500 uppercase">WBC Count</label><input type="number" id="v9" value="7.5" class="m-input"></div>
            </div>
            <button onclick="processTrial()" class="w-full py-3 bg-indigo-600 rounded-lg font-black text-xs hover:bg-indigo-500 shadow-lg uppercase">Process Hybrinear Trial</button>
        </div>

        <div class="bg-black/40 rounded-xl border border-slate-800 p-2">
            <div class="flex justify-between mb-2">
                <button onclick="downloadPDF()" class="text-[8px] text-indigo-400 font-black uppercase">PDF Report</button>
                <button onclick="shareWhatsApp()" class="text-[8px] text-emerald-400 font-black uppercase">WhatsApp</button>
                <button onclick="clearLogs()" class="text-[8px] text-rose-500 font-black uppercase">Clear</button>
            </div>
            <table class="w-full text-[10px] text-left border-collapse"><tbody id="logBody"></tbody></table>
        </div>
    </div>

    <script>
        let sessionData = [];
        let trialCount = 0;

        async function processTrial() {
            const defaults = [120, 80, 72, 98, 16, 36.6, 90, 50, 1.2, 7.5];
            const vitals = Array.from({length: 10}, (_, i) => {
                const val = document.getElementById(`v${i}`).value;
                return val === "" ? defaults[i] : parseFloat(val);
            });
            const gadgetTime = new Date().toLocaleTimeString('en-GB', { hour12: false });

            try {
                const resp = await fetch('https://coherence-vault.vercel.app/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vitals: vitals, gadgetTime: gadgetTime })
                });
                const data = await resp.json();
                
                trialCount++;
                sessionData.push({ ...data, rawVitals: vitals });

                const light = document.getElementById('status-light');
                light.className = `w-24 h-24 mx-auto rounded-full border-4 border-slate-900 flex flex-col justify-center items-center ${data.score <= 0.368 ? 'trigger-red' : 'maintain-green'}`;
                document.getElementById('verdict-label').innerText = data.verdict;
                document.getElementById('omega-value').innerText = data.score.toFixed(4);

                let marker = "";
                if (trialCount % 10 === 0) marker = ` <span class="text-orange-400 font-bold">[CHECKPOINT ${trialCount}]</span>`;
                if (data.score <= 0.368) marker += ` <span class="text-red-500 font-black">[TIPPING POINT REACHED]</span>`;

                const row = `<tr class="border-b border-slate-800 ${data.score <= 0.368 ? 'bg-rose-900/20' : ''}">
                    <td class="p-2 text-[9px] text-slate-500">${data.timestamp}</td>
                    <td class="p-2 font-mono text-[11px]">${data.score.toFixed(4)}</td>
                    <td class="p-2 font-bold text-[10px]">${data.verdict}${marker}</td>
                </tr>`;
                document.getElementById('logBody').insertAdjacentHTML('afterbegin', row);
            } catch (e) { alert("Vault Connection Error."); }
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const pID = document.getElementById('patientID').value || "Patient_Report";
            doc.setFontSize(14); doc.text(`Patient ID: ${pID} | Hybrinear Audit`, 15, 20);
            doc.setFontSize(9); doc.setFont("courier", "bold");
            sessionData.forEach((d, i) => {
                const y = 40 + (i * 18);
                doc.setTextColor(d.score <= 0.368 ? 200 : 0, 0, 0);
                doc.text(`${d.timestamp} | ${d.score.toFixed(4)} | ${d.verdict}`, 15, y);
                doc.setTextColor(100); doc.setFont("courier", "normal");
                doc.text(`Params: ${d.rawVitals.join('/')}`, 15, y + 6);
            });
            doc.save(`Report_${pID}.pdf`);
        }

        function shareWhatsApp() {
            const phone = prompt("Enter number with country code:");
            const pID = document.getElementById('patientID').value || "Unknown";
            let msg = `*Clinical Report: ${pID}*%0A--------------------%0A`;
            sessionData.forEach((d) => {
                msg += `*Time:* ${d.timestamp}%0A*Score:* ${d.score.toFixed(4)} (${d.verdict})%0A*Vitals:* ${d.rawVitals.join('/')}%0A%0A`;
            });
            window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${msg}`);
        }

        function clearLogs() { if(confirm("Clear All Trial Data?")) location.reload(); }
    </script>
</body>
</html>
