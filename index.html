<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khalyx - Vitals Monitoring System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .status-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            border: 3px solid #e0e0e0;
        }
        
        .status-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-label {
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .penalties-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .penalty-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .penalty-item strong {
            display: block;
            color: #333;
            margin-bottom: 5px;
        }
        
        .log-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .log-entry {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .log-data {
            font-size: 0.9em;
            color: #666;
            line-height: 1.8;
        }
        
        .vitals-table {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .vital-row {
            display: flex;
            justify-content: space-between;
            padding: 5px;
        }
        
        .vital-label {
            font-weight: 600;
            color: #333;
        }
        
        .vital-value {
            color: #667eea;
            font-weight: 500;
        }
        
        .tipping-point {
            background: #fff3cd;
            border-left-color: #ffc107 !important;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .penalties-grid {
                grid-template-columns: 1fr;
            }
            
            .vitals-table {
                grid-template-columns: 1fr;
            }
            
            .log-header {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Khalyx</h1>
            <p>Advanced Vitals Monitoring & Deviation Analysis System</p>
        </div>
        
        <div class="content">
            <div class="panel">
                <h2>Patient Information</h2>
                <div class="form-group">
                    <label>Patient ID</label>
                    <input type="text" id="patientId" placeholder="Enter patient ID">
                </div>
                
                <h2 style="margin-top: 30px;">Vital Parameters</h2>
                
                <div class="form-group">
                    <label>Body Temperature (¬∞F)</label>
                    <input type="number" id="temp" step="0.1" placeholder="96.4 - 98.6">
                    <small>Normal: 96.4¬∞F to 98.6¬∞F</small>
                </div>
                
                <div class="form-group">
                    <label>Systolic Pressure (mmHg)</label>
                    <input type="number" id="systolic" placeholder="90 - 120">
                    <small>Normal: 90 - 120 mmHg</small>
                </div>
                
                <div class="form-group">
                    <label>Diastolic Pressure (mmHg)</label>
                    <input type="number" id="diastolic" placeholder="60 - 80">
                    <small>Normal: 60 - 80 mmHg</small>
                </div>
                
                <div class="form-group">
                    <label>Pulse Rate (bpm)</label>
                    <input type="number" id="pulse" placeholder="60 - 90">
                    <small>Normal: 60 - 90 bpm</small>
                </div>
                
                <div class="form-group">
                    <label>Respiratory Rate (breaths/min)</label>
                    <input type="number" id="respiratory" placeholder="12 - 20">
                    <small>Normal: 12 - 20 breaths/min</small>
                </div>
                
                <div class="form-group">
                    <label>Random Sugar (mg/dL)</label>
                    <input type="number" id="sugar" placeholder="70 - 140">
                    <small>Normal: 70 - 140 mg/dL</small>
                </div>
                
                <div class="form-group">
                    <label>Lactate (mmol/L)</label>
                    <input type="number" id="lactate" step="0.1" placeholder="0.5 - 2.0">
                    <small>Normal: 0.5 - 2.0 mmol/L</small>
                </div>
                
                <div class="form-group">
                    <label>SpO2 (%)</label>
                    <input type="number" id="spo2" placeholder="95 - 100">
                    <small>Normal: 95% - 100%</small>
                </div>
                
                <div class="form-group">
                    <label>Urine Output (mL/day)</label>
                    <input type="number" id="urine" placeholder="800 - 2000">
                    <small>Normal: 800 - 2000 mL/day</small>
                </div>
                
                <div class="form-group">
                    <label>WBC Count (cells/ŒºL)</label>
                    <input type="number" id="wbc" placeholder="4500 - 11000">
                    <small>Normal: 4500 - 11000 cells/ŒºL</small>
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="calculateVitals()">Calculate</button>
                    <button class="btn-secondary" onclick="resetForm()">Reset</button>
                </div>
            </div>
            
            <div class="panel">
                <h2>Results</h2>
                
                <div class="status-card" id="statusCard">
                    <div style="color: #999;">Awaiting calculation...</div>
                </div>
                
                <div id="penaltiesSection" style="display: none;">
                    <h3 style="margin-bottom: 15px;">Individual Penalties</h3>
                    <div class="penalties-grid" id="penaltiesGrid"></div>
                </div>
            </div>
            
            <div class="log-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Trial Log</h2>
                    <div class="export-buttons">
                        <button class="btn-primary" onclick="exportPDF()">üìÑ Export PDF</button>
                        <button class="btn-primary" onclick="exportWhatsApp()">üí¨ WhatsApp</button>
                    </div>
                </div>
                <div id="logEntries"></div>
            </div>
        </div>
    </div>

    <script>
        // Anti-debugging and protection
        (function() {
            const devtools = { open: false };
            const threshold = 160;
            
            setInterval(() => {
                if (window.outerWidth - window.innerWidth > threshold || 
                    window.outerHeight - window.innerHeight > threshold) {
                    devtools.open = true;
                    document.body.innerHTML = '<h1 style="text-align:center;margin-top:50px;">Access Denied</h1>';
                }
            }, 500);
            
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                    (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                }
            });
        })();
        
        let trials = [];
        let trialCount = 0;
        
        // Calculation logic - runs in browser
        function calculateDeviation(low, high, value) {
            const v = parseFloat(value);
            if (v >= low && v <= high) return 0.0;
            const deviation = Math.min(Math.abs(v - low), Math.abs(v - high));
            return deviation * 0.1;
        }
        
        async function calculateVitals() {
            const patientId = document.getElementById('patientId').value.trim() || 'Unknown';
            
            const getInputValue = (id) => {
                const element = document.getElementById(id);
                const value = element.value.trim();
                return value !== '' ? parseFloat(value) : null;
            };
            
            const parameters = {
                temp: getInputValue('temp'),
                systolic: getInputValue('systolic'),
                diastolic: getInputValue('diastolic'),
                pulse: getInputValue('pulse'),
                respiratory: getInputValue('respiratory'),
                sugar: getInputValue('sugar'),
                lactate: getInputValue('lactate'),
                spo2: getInputValue('spo2'),
                urine: getInputValue('urine'),
                wbc: getInputValue('wbc')
            };
            
            const missingParams = [];
            for (const [key, value] of Object.entries(parameters)) {
                if (value === null || isNaN(value)) {
                    missingParams.push(key);
                }
            }
            
            if (missingParams.length > 0) {
                alert('Please enter all 10 vital parameters before calculating.\nMissing: ' + missingParams.join(', '));
                return;
            }
            
            try {
                // Try to call API first
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ parameters })
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('API not available, using local calculation');
                }
                
                const result = await response.json();
                displayResults(result);
                logTrial(patientId, parameters, result);
                
            } catch (error) {
                // Fallback to local calculation
                console.log('Using local calculation:', error.message);
                
                const ranges = {
                    temp: [96.4, 98.6],
                    systolic: [90, 120],
                    diastolic: [60, 80],
                    pulse: [60, 90],
                    respiratory: [12, 20],
                    sugar: [70, 140],
                    lactate: [0.5, 2.0],
                    spo2: [95, 100],
                    urine: [800, 2000],
                    wbc: [4500, 11000]
                };
                
                const penalties = {};
                let totalPenalty = 0;
                
                for (const [key, [low, high]] of Object.entries(ranges)) {
                    const penalty = calculateDeviation(low, high, parameters[key]);
                    penalties[key] = Math.round(penalty * 100) / 100;
                    totalPenalty += penalty;
                }
                
                const combined = Math.round(totalPenalty * 1000) / 1000;
                
                let status, color;
                if (combined === 0) {
                    status = 'Normal';
                    color = '#22c55e';
                } else if (combined < 3) {
                    status = 'Maintain';
                    color = '#3b82f6';
                } else if (combined < 10) {
                    status = 'Alert';
                    color = '#f59e0b';
                } else {
                    status = 'Critical';
                    color = '#ef4444';
                }
                
                const result = { penalties, combined, status, color, threshold: 0.368 };
                displayResults(result);
                logTrial(patientId, parameters, result);
            }
        }
        
        function displayResults(result) {
            const card = document.getElementById('statusCard');
            card.style.borderColor = result.color;
            card.innerHTML = `
                <div style="color: ${result.color};" class="status-value">${result.combined}</div>
                <div class="status-label" style="color: ${result.color};">${result.status}</div>
                <div style="margin-top: 15px; color: #666;">
                    Total Penalty Points: ${result.combined}
                </div>
            `;
            
            const grid = document.getElementById('penaltiesGrid');
            grid.innerHTML = '';
            
            const labels = {
                temp: 'Temperature',
                systolic: 'Systolic BP',
                diastolic: 'Diastolic BP',
                pulse: 'Pulse Rate',
                respiratory: 'Respiratory',
                sugar: 'Blood Sugar',
                lactate: 'Lactate',
                spo2: 'SpO2',
                urine: 'Urine Output',
                wbc: 'WBC Count'
            };
            
            for (const [key, value] of Object.entries(result.penalties)) {
                const div = document.createElement('div');
                div.className = 'penalty-item';
                const displayValue = value === 0 ? '‚úì Normal' : value.toFixed(2) + ' penalty';
                div.innerHTML = `<strong>${labels[key]}</strong><span>${displayValue}</span>`;
                grid.appendChild(div);
            }
            
            document.getElementById('penaltiesSection').style.display = 'block';
        }
        
        function logTrial(patientId, parameters, result) {
            trialCount++;
            const timestamp = new Date().toLocaleString();
            
            const isTippingPoint = trialCount % 10 === 0 && result.combined > 10;
            
            trials.push({
                number: trialCount,
                patientId,
                timestamp,
                parameters,
                result,
                isTippingPoint
            });
            
            const logDiv = document.getElementById('logEntries');
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (isTippingPoint ? ' tipping-point' : '');
            
            entry.innerHTML = `
                <div class="log-header">
                    <span><strong>Trial #${trialCount}</strong> - Patient: ${patientId}</span>
                    <span>${timestamp}</span>
                </div>
                <div class="log-data">
                    <div class="vitals-table">
                        <div class="vital-row">
                            <span class="vital-label">Temperature:</span>
                            <span class="vital-value">${parameters.temp}¬∞F</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">Systolic BP:</span>
                            <span class="vital-value">${parameters.systolic} mmHg</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">Diastolic BP:</span>
                            <span class="vital-value">${parameters.diastolic} mmHg</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">Pulse Rate:</span>
                            <span class="vital-value">${parameters.pulse} bpm</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">Respiratory:</span>
                            <span class="vital-value">${parameters.respiratory} /min</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">Blood Sugar:</span>
                            <span class="vital-value">${parameters.sugar} mg/dL</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">Lactate:</span>
                            <span class="vital-value">${parameters.lactate} mmol/L</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">SpO2:</span>
                            <span class="vital-value">${parameters.spo2}%</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">Urine Output:</span>
                            <span class="vital-value">${parameters.urine} mL/day</span>
                        </div>
                        <div class="vital-row">
                            <span class="vital-label">WBC Count:</span>
                            <span class="vital-value">${parameters.wbc} cells/ŒºL</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #e0e0e0;">
                        <strong>Total Penalty:</strong> <span style="color: ${result.color}; font-weight: bold;">${result.combined}</span> - 
                        <strong>Status:</strong> <span style="color: ${result.color}; font-weight: bold;">${result.status}</span>
                        ${isTippingPoint ? '<br><strong style="color: #ff6b6b;">‚ö†Ô∏è TIPPING POINT CROSSED</strong>' : ''}
                    </div>
                </div>
            `;
            
            logDiv.insertBefore(entry, logDiv.firstChild);
        }
        
        function resetForm() {
            const inputIds = ['patientId', 'temp', 'systolic', 'diastolic', 'pulse', 'respiratory', 'sugar', 'lactate', 'spo2', 'urine', 'wbc'];
            
            inputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            const statusCard = document.getElementById('statusCard');
            statusCard.style.borderColor = '#e0e0e0';
            statusCard.innerHTML = '<div style="color: #999;">Awaiting calculation...</div>';
            
            document.getElementById('penaltiesSection').style.display = 'none';
            document.getElementById('penaltiesGrid').innerHTML = '';
        }
        
        function exportPDF() {
            if (trials.length === 0) {
                alert('No trials to export. Please calculate at least one trial first.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Khalyx - Vitals Monitoring Report', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 22, { align: 'center' });
            doc.text(`Total Trials: ${trials.length}`, 105, 27, { align: 'center' });
            
            let y = 35;
            
            trials.forEach((trial) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Trial #${trial.number} - Patient: ${trial.patientId}`, 15, y);
                y += 6;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(`Timestamp: ${trial.timestamp}`, 15, y);
                y += 7;
                
                doc.setFont(undefined, 'bold');
                doc.text('Vital Parameters:', 15, y);
                y += 5;
                doc.setFont(undefined, 'normal');
                
                doc.text(`Temperature: ${trial.parameters.temp}¬∞F`, 20, y);
                doc.text(`Systolic BP: ${trial.parameters.systolic} mmHg`, 110, y);
                y += 4;
                
                doc.text(`Diastolic BP: ${trial.parameters.diastolic} mmHg`, 20, y);
                doc.text(`Pulse Rate: ${trial.parameters.pulse} bpm`, 110, y);
                y += 4;
                
                doc.text(`Respiratory Rate: ${trial.parameters.respiratory} /min`, 20, y);
                doc.text(`Blood Sugar: ${trial.parameters.sugar} mg/dL`, 110, y);
                y += 4;
                
                doc.text(`Lactate: ${trial.parameters.lactate} mmol/L`, 20, y);
                doc.text(`SpO2: ${trial.parameters.spo2}%`, 110, y);
                y += 4;
                
                doc.text(`Urine Output: ${trial.parameters.urine} mL/day`, 20, y);
                doc.text(`WBC Count: ${trial.parameters.wbc} cells/ŒºL`, 110, y);
                y += 6;
                
                doc.setFont(undefined, 'bold');
                doc.text(`Total Penalty: ${trial.result.combined} - Status: ${trial.result.status}`, 15, y);
                y += 5;
                
                if (trial.isTippingPoint) {
                    doc.setTextColor(255, 0, 0);
                    doc.text('‚ö†Ô∏è WARNING: TIPPING POINT CROSSED', 15, y);
                    doc.setTextColor(0, 0, 0);
                    y += 5;
                }
                
                doc.setDrawColor(200, 200, 200);
                doc.line(15, y, 195, y);
                y += 7;
            });
            
            doc.save(`khalyx_vitals_report_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        function exportWhatsApp() {
            if (trials.length === 0) {
                alert('No trials to export. Please calculate at least one trial first.');
                return;
            }
            
            let message = '*üè• KHALYX VITALS MONITORING REPORT*\n';
            message += '‚ïê'.repeat(35) + '\n';
            message += `Generated: ${new Date().toLocaleString()}\n`;
            message += `Total Trials: ${trials.length}\n`;
            message += '‚ïê'.repeat(35) + '\n\n';
            
            trials.forEach(trial => {
                message += `*Trial #${trial.number}* - Patient: *${trial.patientId}*\n`;
                message += `üïê ${trial.timestamp}\n\n`;
                
                message += '*üìä VITAL PARAMETERS:*\n';
                message += `üå°Ô∏è Temperature: ${trial.parameters.temp}¬∞F\n`;
                message += `üíâ Blood Pressure: ${trial.parameters.systolic}/${trial.parameters.diastolic} mmHg\n`;
                message += `‚ù§Ô∏è Pulse Rate: ${trial.parameters.pulse} bpm\n`;
                message += `ü´Å Respiratory Rate: ${trial.parameters.respiratory} /min\n`;
                message += `üç¨ Blood Sugar: ${trial.parameters.sugar} mg/dL\n`;
                message += `üß™ Lactate: ${trial.parameters.lactate} mmol/L\n`;
                message += `üí® SpO2: ${trial.parameters.spo2}%\n`;
                message += `üíß Urine Output: ${trial.parameters.urine} mL/day\n`;
                message += `üî¨ WBC Count: ${trial.parameters.wbc} cells/ŒºL\n\n`;
                
                message += `*üìà ASSESSMENT:*\n`;
                message += `Total Penalty: *${trial.result.combined}*\n`;
                message += `Status: *${trial.result.status}*\n`;
                
                if (trial.isTippingPoint) {
                    message += `\n‚ö†Ô∏è *CRITICAL: TIPPING POINT CROSSED*\n`;
                }
                
                message += '\n' + '‚îÄ'.repeat(35) + '\n\n';
            });
            
            message += '*Khalyx Vitals Monitoring System*\n';
            message += `Report generated on ${new Date().toLocaleDateString()}`;
            
            const encoded = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encoded}`, '_blank');
        }
    </script>
</body>
</html>
